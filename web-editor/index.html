<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunaTV Config Editor</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="auth-container">
        <button id="login-btn">Login with GitHub</button>
    </div>
    <div id="editor-container" style="display:none;">
        <h2>Edit luna-tv-config.json</h2>
        <textarea id="json-editor" rows="20" cols="50"></textarea>
        <br />
        <button id="save-btn">Save Changes</button>
    </div>

    <script src="oauth.js"></script>
    <script>
        document.getElementById('login-btn').addEventListener('click', function() {
            oauthLogin();
        });

        document.getElementById('save-btn').addEventListener('click', function() {
            saveConfig();
        });

        function saveConfig() {
            const editedJson = document.getElementById('json-editor').value;
            const jsonData = JSON.parse(editedJson);
            const token = localStorage.getItem('github_token');
            fetch('https://api.github.com/repos/hafrey1/LunaTV-config/contents/luna-tv-config.json', {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Updated luna-tv-config.json via web editor',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(jsonData)))),
                    sha: localStorage.getItem('file_sha')
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Config saved successfully!');
            })
            .catch(error => {
                console.error('Error saving config:', error);
                alert('Failed to save config.');
            });
        }

        function loadConfig() {
            const token = localStorage.getItem('github_token');
            fetch('https://api.github.com/repos/hafrey1/LunaTV-config/contents/luna-tv-config.json', {
                headers: {
                    'Authorization': `token ${token}`,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    const jsonContent = decodeURIComponent(escape(atob(data.content)));
                    document.getElementById('json-editor').value = jsonContent;
                    localStorage.setItem('file_sha', data.sha);
                    document.getElementById('editor-container').style.display = 'block';
                    document.getElementById('auth-container').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading config:', error);
                alert('Failed to load config.');
            });
        }

        window.onload = function() {
            const token = localStorage.getItem('github_token');
            if (token) {
                loadConfig();
            }
        };
    </script>
</body>
</html>
