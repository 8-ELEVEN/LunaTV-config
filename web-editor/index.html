<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna TV Config 编辑器</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Luna TV Config 编辑器</h1>
        <p>请登录 GitHub 后编辑配置文件。</p>
        
        <!-- 登录按钮 -->
        <button id="loginBtn">登录 GitHub</button>

        <!-- 加载配置按钮 -->
        <button id="loadBtn" style="display:none;">加载配置文件</button>

        <!-- 配置文件编辑区域 -->
        <textarea id="configContent" rows="20" cols="80" style="display:none;"></textarea>

        <!-- 保存按钮 -->
        <button id="saveBtn" style="display:none;">保存配置</button>

        <p id="status" style="color: green;"></p>
    </div>

    <!-- 引入 Axios 库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入自定义 JavaScript 文件 -->
    <script src="oauth.js"></script>

    <script>
        const loginBtn = document.getElementById('loginBtn');
        const loadBtn = document.getElementById('loadBtn');
        const saveBtn = document.getElementById('saveBtn');
        const configContent = document.getElementById('configContent');
        const statusElement = document.getElementById('status');
        const CLIENT_ID = 'Ov23ligWR1OA4D8xEHN4'; // 你的 GitHub OAuth 客户端 ID
        const REDIRECT_URI = 'https://hafrey1.github.io/LunaTV-config/web-editor/callback.html'; // GitHub OAuth 回调 URL
        const REPO = 'hafrey1/LunaTV-config'; // 你的 GitHub 仓库名
        const FILE_PATH = 'luna-tv-config.json'; // 需要编辑的文件路径

        // 登录按钮点击事件
        loginBtn.addEventListener('click', () => {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=repo`;
            window.location.href = authUrl; // 跳转到 GitHub OAuth 登录页面
        });

        // 页面加载时判断是否已经获得 Access Token
        const token = localStorage.getItem('access_token');
        if (token) {
            loginBtn.style.display = 'none';
            loadBtn.style.display = 'inline-block';
            loadBtn.addEventListener('click', async () => {
                const configData = await getConfigFile(token);
                configContent.style.display = 'block';
                configContent.value = configData; // 显示文件内容
                saveBtn.style.display = 'inline-block';
                saveBtn.addEventListener('click', async () => {
                    const sha = await getFileSha(token);
                    const newConfig = configContent.value;
                    await updateConfigFile(token, newConfig, sha);
                    statusElement.textContent = '配置文件更新成功！';
                    statusElement.style.color = 'green';
                });
            });
        }
    </script>
</body>
</html>
